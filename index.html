<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Atelier MobilitÃ© - GoDifferent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

  <div class="background-animation"></div>

  <div class="container">
    
    <header>
        <img src="image.png" alt="Logo" class="brand-logo">
        <div class="step-indicator">
            <div class="step-dot active" id="step1Dot">1</div>
            <div class="step-dot" id="step2Dot">2</div>
            <div class="step-dot" id="step3Dot">3</div>
            <div class="step-dot" id="step4Dot">4</div>
            <div class="step-dot" id="step5Dot">5</div>
            <div class="step-dot" id="step6Dot">6</div>
        </div>
    </header>

    <!-- Notice RGPD -->
    <div id="rgpdNotice" class="card glass-effect" style="border-left: 4px solid #10b981;">
      <p style="font-size: 0.9em; margin-bottom: 15px;">
        â„¹ï¸ Vos donnÃ©es sont stockÃ©es temporairement pour l'atelier.
        <a href="#" onclick="showRGPDDetails(); return false;" style="color: #FFD700; text-decoration: underline;">En savoir plus</a>
      </p>
      <button class="btn-primary" onclick="acceptRGPD()">âœ… J'accepte</button>
    </div>

    <!-- Ã‰tape 1 : Config -->
    <div id="step1" class="step active">
      <div class="card glass-effect">
        <h1>ğŸš€ Bienvenue !</h1>
        <div id="loginSection">
            <p class="subtitle">Entrez le code de l'atelier.</p>
            <input type="text" id="accessCodeInput" placeholder="Code d'accÃ¨s" />
            <button class="btn-primary" onclick="checkAccessCode()">Valider</button>
        </div>
        <div id="locationSection" style="display: none;">
          <h3>ğŸ“ Votre profil</h3>
          <div class="input-group"><label>Adresse de dÃ©part</label><input id="userAddress" placeholder="Ex: 10 rue de la LibertÃ©, Strasbourg" /></div>
          <div class="input-group"><label>Mode de transport principal</label>
            <select id="transportMode">
                <option value="">-- Choisir --</option>
                <option value="car-thermal">ğŸš— Voiture thermique</option>
                <option value="car-electric">âš¡ Voiture Ã©lectrique</option>
                <option value="carpool">ğŸš™ Covoiturage</option>
                <option value="train">ğŸš† Train/TER</option>
                <option value="bus">ğŸšŒ Bus/Tram</option>
                <option value="bike">ğŸš² VÃ©lo</option>
                <option value="ebike">ğŸš´ VÃ©lo Ã©lectrique</option>
                <option value="walk">ğŸš¶ Marche</option>
                <option value="remote">ğŸ’» TÃ©lÃ©travail</option>
            </select>
          </div>
          <div class="input-group"><label>Heure de dÃ©part habituelle</label><input type="time" id="departureTime" value="07:30" /></div>
          <div style="text-align:center; margin:15px 0;"><label class="checkbox-item"><input type="checkbox" id="multimodalCheck" onchange="toggleMultimodal()"> J'alterne plusieurs modes</label></div>
          <button class="btn-primary" id="saveLocation">Valider ma localisation</button>
        </div>
        <div id="afterLocationSection" style="display: none;">
          <div class="success-msg">âœ… Profil enregistrÃ© !</div>
          <div class="emoji-display"><div id="myEmojiDisplay" style="font-size: 4rem;"></div></div>
          <div class="info-box"><strong>ğŸ“</strong> <span id="detectedAddress"></span></div>
          <button class="btn-secondary" onclick="showInvitePage()">ğŸ“¨ Inviter un collÃ¨gue</button>
          <button class="btn-primary" onclick="showStep(2)">Commencer ğŸ®</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 2 : Rencontres -->
    <div id="step2" class="step">
      <div class="card glass-effect">
        <h2>ğŸ¤ Rencontres</h2>
        <p class="subtitle">Scannez un maximum de collÃ¨gues !</p>
        <div class="qr-wrapper"><div id="qrcode"></div></div>
        <div class="camera-container" id="cameraView"><video id="video" autoplay playsinline muted></video><div class="scan-overlay"></div></div>
        <button class="btn-outline" id="stopCamBtn" style="display:none;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>
        <button class="btn-primary" id="scanBtn" onclick="startScanLoop('normal')">ğŸ“± Scanner un collÃ¨gue</button>
        
        <div id="challengeSection" style="display:none; margin-top:15px;">
            <div class="feedback-card"><h3 id="challengeTitle"></h3><p id="challengeTask"></p><button class="btn-secondary" id="continueChallengeBtn">OK, continuer</button></div>
        </div>
        
        <div class="progress-container"><div class="progress-bar"><div class="progress-fill" id="step2Progress" style="width:0%"></div></div><p style="text-align:center;">Scans : <span id="scanCount">0</span></p></div>
        <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(1)">Retour</button><button class="btn-primary" id="goToStep3" disabled onclick="showStep(3)">Suivant â†’</button></div>
      </div>
    </div>

    <!-- Ã‰tape 3 : Voisins -->
    <div id="step3" class="step">
      <div class="card glass-effect">
        <h2>ğŸ¯ Trouvez vos voisins</h2>
        <p class="subtitle">Retrouvez 3 de vos 5 plus proches voisins</p>
        <div class="qr-wrapper-small"><div id="qrcodeStep3"></div></div>
        <div class="game-header"><div class="score-box"><span class="score-val" id="scoreBadge">0/3</span><span class="score-label">TrouvÃ©s</span></div><div class="score-box"><span class="score-val" id="attemptsLeft">5</span><span class="score-label">Essais</span></div></div>
        <div id="targetList"></div>
        <div class="camera-container" id="gameCameraView"><video id="gameVideo" autoplay playsinline muted></video></div>
        <button class="btn-outline" id="stopGameCamBtn" style="display:none;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>
        <button class="btn-primary" id="gameScanBtn" onclick="startScanLoop('game')">ğŸ“± Scanner</button>
        <div id="gameResult"></div>
        <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(2)">Retour</button><button class="btn-primary" onclick="showStep(4)">Suivant â†’</button></div>
      </div>
    </div>

    <!-- Ã‰tape 4 : Positionnement -->
    <div id="step4" class="step">
      <div class="card glass-effect">
        <h2>ğŸ—ºï¸ Positionnement</h2>
        <div class="info-box">
            <p><strong>Consigne :</strong> Scannez les repÃ¨res muraux et vos voisins pour vous positionner dans l'espace.</p>
        </div>
        <div class="qr-wrapper-small"><div id="qrcodeStep4"></div></div>
        <div class="camera-container" id="positioningCameraView"><video id="positioningVideo" autoplay playsinline muted></video></div>
        <button class="btn-outline" id="stopPosCamBtn" style="display:none;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>
        <button class="btn-primary" id="positioningScanBtn" onclick="startScanLoop('positioning')">ğŸ“± Scanner</button>
        <div class="navigation-buttons">
            <button class="btn-outline" onclick="showStep(3)">Retour</button>
            <button class="btn-primary" onclick="showStep(5)">âœ… Je suis placÃ©</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 5 : Pelotes -->
    <div id="step5" class="step">
      <div class="card glass-effect">
        <h2>ğŸ§¶ Visualisation des flux</h2>
        <div class="info-box" style="background: rgba(255,255,255,0.1); border-left: 4px solid #F59E0B;">
          <p>Avec vos voisins, dessinez votre trajet avec les pelotes de laine.</p>
          <ul style="margin-left:20px; margin-top:10px;"><li>ğŸŸ¡ Voiture</li><li>ğŸ”µ VÃ©lo/Marche</li><li>ğŸŒ¸ TC</li></ul>
        </div>
        <div class="stats-grid"><div class="stat-card"><div class="stat-number" id="totalParticipants">0</div><span>Participants</span></div><div class="stat-card"><div class="stat-number" id="avgDistance">0</div><span>Km moyenne</span></div></div>
        <div class="navigation-buttons">
            <button class="btn-outline" onclick="showStep(4)">Retour</button>
            <button class="btn-primary" onclick="showStep('stepCoConstruction')">Discussion ğŸ’¬</button>
        </div>
      </div>
    </div>

    <!-- ============ NOUVELLE PHASE CO-CONSTRUCTION ============ -->
    <div id="stepCoConstruction" class="step">
        <div class="card glass-effect">
            
            <!-- Phase 1 : Formation du groupe -->
            <div id="groupFormationSection">
                <h2>ğŸ‘¥ Formez votre groupe</h2>
                <div class="info-box" style="background: #e0f2fe; color: #0c4a6e; border-left: 4px solid #0ea5e9;">
                    <p>Mettez-vous en cercle avec vos voisins (3 Ã  5 personnes).</p>
                    <p style="margin-top:10px;"><strong>Qui prend le tÃ©lÃ©phone ?</strong></p>
                    <div id="leaderChallenge" style="font-weight:bold; font-size:1.1em; text-align:center; padding:10px; border:2px dashed #0284c7; margin-top:5px; border-radius:8px;">
                        ğŸ² Cliquez pour dÃ©signer
                    </div>
                </div>

                <div id="groupScanInterface" style="display:none; margin-top:15px;">
                    <p>Le chef scanne les membres :</p>
                    <div class="camera-container" id="groupCameraView" style="height:200px;"><video id="groupVideo" autoplay playsinline muted></video></div>
                    <button class="btn-primary" onclick="startScanLoop('group')">â• Scanner un membre</button>
                    <div id="groupMembersList" style="margin:10px 0;"></div>
                    <button class="btn-secondary" id="validateGroupBtn" onclick="validateGroup()" disabled>âœ… Groupe complet</button>
                </div>
                
                <button class="btn-primary" id="startGroupBtn" onclick="initGroupPhase()">ğŸ² DÃ©signer le chef</button>
            </div>

            <!-- Phase 2 : Nouvelle interface Co-construction -->
            <div id="newCoConstructionSection" style="display:none;">
                
                <!-- Phase 2.1 : Choix du rÃ´le -->
                <div id="coConstPhase1">
                    <h2>ğŸ­ Qui Ãªtes-vous ?</h2>
                    <p style="text-align:center; opacity:0.8; margin-bottom:15px;">Chaque membre choisit son profil :</p>
                    <div id="roleSelector" class="roles-grid"></div>
                    <div id="selectedRoleMission"></div>
                    <button class="btn-primary" id="goToPhase2Btn" onclick="goToPhase2()" disabled style="margin-top:20px;">Continuer â†’</button>
                </div>
                
                <!-- Phase 2.2 : Choix des thÃ©matiques -->
                <div id="coConstPhase2" style="display:none;">
                    <h2>ğŸ“‹ Choisissez vos sujets</h2>
                    <div id="themeSelector"></div>
                    <button class="btn-primary" id="goToPhase3Btn" onclick="goToPhase3()" disabled style="margin-top:20px;">Lancer la discussion â†’</button>
                    <button class="btn-outline" onclick="backToPhase1()" style="margin-top:10px;">â† Retour</button>
                </div>
                
                <!-- Phase 2.3 : Discussion guidÃ©e -->
                <div id="coConstPhase3" style="display:none;">
                    <h2>ğŸ’¬ Discussion</h2>
                    <p style="text-align:center; opacity:0.8; margin-bottom:15px;">Cliquez sur une question pour la poser au groupe</p>
                    <div id="discussionCardsContainer"></div>
                    <div style="margin-top:20px;">
                        <label>ğŸ“ Note du groupe :</label>
                        <textarea id="groupNote" rows="3" placeholder="IdÃ©es clÃ©s, contacts Ã©changÃ©s..."></textarea>
                    </div>
                    <button class="btn-primary" onclick="goToPhase4()" style="margin-top:15px;">Terminer la discussion â†’</button>
                    <button class="btn-outline" onclick="backToPhase2()" style="margin-top:10px;">â† Retour</button>
                </div>
                
                <!-- Phase 2.4 : Engagement soft -->
                <div id="coConstPhase4" style="display:none;">
                    <h2>ğŸŒ± Et maintenant ?</h2>
                    <p style="text-align:center; opacity:0.8; margin-bottom:15px;">Pas d'obligation, juste des envies...</p>
                    <div id="engagementContainer"></div>
                    <button class="btn-primary" onclick="finishCoConstruction()" style="margin-top:20px;">Terminer âœ¨</button>
                    <button class="btn-outline" onclick="backToPhase3()" style="margin-top:10px;">â† Retour</button>
                </div>
                
            </div>
            
            <div class="navigation-buttons" style="margin-top:20px;">
                <button class="btn-outline" onclick="showStep(5)">â† Retour Ã©tape 5</button>
            </div>
        </div>
    </div>

    <!-- Ã‰tape 6 : Propositions individuelles -->
    <div id="step6" class="step">
      <div class="card glass-effect">
        <h2>ğŸ“ Mes propositions</h2>
        <h3>Alternatives envisagÃ©es</h3><div id="alternativesList"></div>
        <h3 style="margin-top:15px;">Mes contraintes</h3><div id="constraintsList"></div>
        <h3 style="margin-top:15px;">Leviers attendus</h3><div id="leversList"></div>
        <h3 style="margin-top:15px;">Mon engagement</h3>
        <div class="range-container"><input type="range" id="commitmentRange" min="0" max="100" value="80" oninput="updateCommitmentValue()"><div class="range-value"><span id="commitmentValue">80</span>%</div></div>
        <div class="navigation-buttons">
            <button class="btn-outline" onclick="showStep('stepCoConstruction')">â† Retour</button>
            <button class="btn-primary" onclick="showCompanyScan()">Finaliser â†’</button>
        </div>
      </div>
    </div>

    <!-- Scan Entreprise -->
    <div id="companyScanPage" class="step">
      <div class="card glass-effect">
        <h2>ğŸ¢ Scan final</h2>
        <p>Scannez le QR code de l'entreprise</p>
        <div class="camera-container" id="companyCameraView"><video id="companyVideo" autoplay playsinline muted></video></div>
        <button class="btn-outline" id="stopCompCamBtn" style="display:none;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>
        <button class="btn-primary" onclick="startScanLoop('company')">ğŸ“± Scanner</button>
        <button class="btn-outline" onclick="showStep(6)" style="margin-top:15px;">â† Modifier mes choix</button>
      </div>
    </div>

    <!-- Rapport -->
    <div id="reportPage" class="step">
      <div class="card glass-effect">
        <h2>ğŸ‰ Votre bilan</h2>
        <div class="co2-savings"><p>Gain potentiel</p><div class="co2-number" id="co2Savings">0</div><span>kg COâ‚‚/an</span></div>
        <button class="btn-primary" onclick="generatePDF()" style="margin-top:20px;">ğŸ“„ TÃ©lÃ©charger mon bilan</button>
      </div>
    </div>

    <!-- Admin -->
    <div id="adminPage" class="step">
      <div class="card glass-effect">
        <h2>ğŸ” Administration</h2>
        <div id="adminLogin"><input type="password" id="adminPassword" placeholder="Mot de passe" /><button class="btn-primary" onclick="adminLogin()">Connexion</button></div>
        <div id="adminPanel" style="display:none;">
            <h3>QR Entreprise</h3>
            <input id="companyAddressInput" placeholder="Adresse de l'entreprise" /><button class="btn-primary" onclick="generateCompanyQR()">GÃ©nÃ©rer</button>
            <div id="companyQRSection" style="display:none; background:white; padding:10px; border-radius:10px; margin-top:10px;">
                <div id="companyQrcode"></div>
            </div>
            <button class="btn-secondary" onclick="exportExcel()" style="margin-top:20px;">ğŸ“¥ Exporter Excel</button>
            <button class="btn-outline" onclick="showStep(1)" style="margin-top:10px;">â† Retour</button>
        </div>
      </div>
    </div>

    <!-- Invitation -->
    <div id="invitePage" class="step">
        <div class="card glass-effect invite-card">
            <h2 style="color:#F59E0B;">ğŸ“¨ Inviter un collÃ¨gue</h2>
            <p style="text-align:center;">Montrez ce QR code Ã  un collÃ¨gue</p>
            <div id="inviteTimer" style="text-align:center; margin:10px 0;"></div>
            <div class="qr-wrapper qr-invite-wrapper"><div id="inviteQrcode"></div></div>
            <button class="btn-outline" onclick="showStep(1)">â† Retour</button>
        </div>
    </div>

    <!-- Modale Multimodal -->
    <div id="multimodalModal" class="modal">
      <div class="modal-content glass-effect" style="background:#1e293b;">
        <h2>ğŸ”„ Modes multiples</h2>
        <label>Mode secondaire :</label>
        <select id="transportMode2" style="margin-top:10px;">
            <option value="">-- Choisir --</option>
            <option value="car-thermal">ğŸš— Voiture</option>
            <option value="carpool">ğŸš™ Covoiturage</option>
            <option value="train">ğŸš† Train</option>
            <option value="bus">ğŸšŒ Bus/Tram</option>
            <option value="bike">ğŸš² VÃ©lo</option>
            <option value="ebike">ğŸš´ VAE</option>
            <option value="walk">ğŸš¶ Marche</option>
            <option value="remote">ğŸ’» TÃ©lÃ©travail</option>
        </select>
        <p style="margin: 15px 0;">RÃ©partition (jours/semaine) :</p>
        <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
            <div style="text-align:center;"><input type="number" id="mode1Days" value="3" min="0" max="5" style="width:60px;"><div style="font-size:0.8em;">Mode 1</div></div>
            <div style="font-size:1.5em; opacity:0.5;">/</div>
            <div style="text-align:center;"><input type="number" id="mode2Days" value="2" min="0" max="5" style="width:60px;"><div style="font-size:0.8em;">Mode 2</div></div>
        </div>
        <div class="navigation-buttons">
            <button class="btn-outline" onclick="closeMultimodal()">Annuler</button>
            <button class="btn-primary" onclick="saveMultimodal()">Valider</button>
        </div>
      </div>
    </div>

    <!-- Boutons flottants -->
    <button class="reset-floating-btn" onclick="resetGameSequence()">ğŸ”„</button>
    <button class="admin-floating-btn" onclick="showAdminPage()">ğŸ”</button>
    
    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  <script src="config.js"></script>
  <script src="script.js"></script>
</body>
</html>
