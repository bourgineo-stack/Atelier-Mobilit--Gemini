<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Atelier MobilitÃ©</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

  <div class="background-animation"></div>

  <div class="container">
    
    <header>
        <img src="image.png" alt="Logo" class="brand-logo">
        <div class="step-indicator">
            <div class="step-dot active" id="step1Dot">1</div>
            <div class="step-dot" id="step2Dot">2</div>
            <div class="step-dot" id="step3Dot">3</div>
            <div class="step-dot" id="step4Dot">4</div>
            <div class="step-dot" id="step5Dot">5</div>
            <div class="step-dot" id="step6Dot">6</div>
        </div>
    </header>

    <!-- Notice RGPD -->
    <div id="rgpdNotice" class="card glass-effect" style="border-left: 4px solid #10b981;">
      <p style="font-size: 0.9em; margin-bottom: 15px;">
        â„¹ï¸ Vos donnÃ©es sont stockÃ©es temporairement pour l'atelier.
        <a href="#" onclick="showRGPDDetails(); return false;" style="color: #FFD700; text-decoration: underline; cursor: pointer; font-weight:bold;">En savoir plus</a>
      </p>
      <button class="btn-primary" onclick="acceptRGPD()">âœ… J'accepte et je continue</button>
    </div>

    <!-- Ã‰tape 1 : Config -->
    <div id="step1" class="step active">
      <div class="card glass-effect">
        <h1>ğŸš€ Bienvenue !</h1>
        <div id="loginSection">
            <p class="subtitle">Entrez le code de l'atelier.</p>
            <input type="text" id="accessCodeInput" placeholder="Code d'accÃ¨s" />
            <button class="btn-primary" onclick="checkAccessCode()">Valider</button>
            <div class="error-msg"></div>
        </div>
        <div id="locationSection" style="display: none;">
          <h3>ğŸ“ Profil</h3>
          <div class="input-group"><label>Adresse</label><input id="userAddress" placeholder="Ex: 10 rue de la LibertÃ©" /></div>
          <div class="input-group"><label>Mode</label>
            <select id="transportMode">
                <option value="">-- Choisir --</option>
                <option value="car-thermal">ğŸš— Voiture thermique</option>
                <option value="car-electric">âš¡ Voiture Ã©lec</option>
                <option value="carpool">ğŸš™ Covoiturage</option>
                <option value="train">ğŸš† Train/RER</option>
                <option value="bus">ğŸšŒ Bus/Tram</option>
                <option value="bike">ğŸš² VÃ©lo</option>
                <option value="ebike">ğŸš´ VÃ©lo Ã©lec</option>
                <option value="walk">ğŸš¶ Marche</option>
                <option value="remote">ğŸ’» TÃ©lÃ©travail</option>
            </select>
          </div>
          <div class="input-group"><label>DÃ©part</label><input type="time" id="departureTime" value="07:30" /></div>
          <div style="text-align:center; margin:15px 0;"><label class="checkbox-item"><input type="checkbox" id="multimodalCheck" onchange="toggleMultimodal()"> J'alterne entre plusieurs modes</label></div>
          <button class="btn-primary" id="saveLocation">Valider</button>
        </div>
        <div id="afterLocationSection" style="display: none;">
          <div class="success-msg">âœ… EnregistrÃ© !</div>
          <div class="emoji-display"><div id="myEmojiDisplay" style="font-size: 4rem;"></div></div>
          <div class="info-box"><strong>ğŸ“ Adresse :</strong> <span id="detectedAddress"></span></div>
          <button class="btn-secondary" onclick="showInvitePage()">ğŸ“¨ Inviter un collÃ¨gue</button>
          <button class="btn-primary" onclick="showStep(2)">Lancer le jeu ğŸ®</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 2 : Rencontres -->
    <div id="step2" class="step">
      <div class="card glass-effect">
        <h2>ğŸ¤ Rencontres</h2>
        <div class="qr-wrapper"><div id="qrcode"></div></div>
        <div class="camera-container" id="cameraView"><video id="video" autoplay playsinline muted></video><div class="scan-overlay"></div></div>
        <button class="btn-outline" id="stopCamBtn" style="display:none;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>
        <button class="btn-primary" id="scanBtn" onclick="startScanLoop('normal')">ğŸ“± Scanner</button>
        
        <div id="challengeSection" style="display:none; margin-top:15px;">
            <div class="feedback-card"><h3 id="challengeTitle"></h3><p id="challengeTask"></p><button class="btn-secondary" id="continueChallengeBtn">OK</button></div>
        </div>
        
        <div class="progress-container"><div class="progress-bar"><div class="progress-fill" id="step2Progress" style="width:0%"></div></div><p style="text-align:center;">Scans : <span id="scanCount">0</span></p></div>
        <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(1)">Retour</button><button class="btn-primary" id="goToStep3" disabled onclick="showStep(3)">Suivant</button></div>
      </div>
    </div>

    <!-- Ã‰tape 3 : Voisins -->
    <div id="step3" class="step">
      <div class="card glass-effect">
        <h2>ğŸ¯ Voisins</h2>
        <div class="qr-wrapper-small"><div id="qrcodeStep3"></div></div>
        <div class="game-header"><div class="score-box"><span class="score-val" id="scoreBadge">0/3</span></div><div class="score-box"><span class="score-val" id="attemptsLeft">5</span></div></div>
        <div id="targetList"></div>
        <div class="camera-container" id="gameCameraView" style="display:none;"><video id="gameVideo" autoplay playsinline muted></video></div>
        <button class="btn-outline" id="stopGameCamBtn" style="display:none;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>
        <button class="btn-primary" id="gameScanBtn" onclick="startScanLoop('game')">ğŸ“± Scanner Voisin</button>
        <div id="gameResult"></div>
        <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(2)">Retour</button><button class="btn-primary" onclick="showStep(4)">Suivant</button></div>
      </div>
    </div>

    <!-- Ã‰tape 4 : Positionnement -->
    <div id="step4" class="step">
      <div class="card glass-effect">
        <h2>ğŸ—ºï¸ Position</h2>
        <div class="info-box">
            <p>Nous allons tenter de nous placer correctement dans l'espace pour dessiner la carte du domicile-travail.</p>
            <p style="font-size:0.9em; margin-top:5px;">Scannez les QR codes "RepÃ¨res" ğŸ“ dans la salle.</p>
        </div>
        
        <!-- VISUEL EXPLICATIF -->
        <div class="map-schematic">
            <div class="map-center">ğŸ¢</div>
            <div class="map-point p1">ğŸ‘¤</div>
            <div class="map-point p2">ğŸ‘¤</div>
            <div class="map-point p3">ğŸ“</div>
            <div class="map-radar"></div>
        </div>

        <div class="qr-wrapper-small"><div id="qrcodeStep4"></div></div>
        <div class="camera-container" id="positioningCameraView" style="display:none;"><video id="positioningVideo" autoplay playsinline muted></video></div>
        <button class="btn-outline" id="stopPosCamBtn" style="display:none;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>
        <button class="btn-primary" id="positioningScanBtn" onclick="startScanLoop('positioning')">ğŸ“± Scanner repÃ¨re</button>
        
        <div class="navigation-buttons">
            <button class="btn-outline" onclick="showStep(3)">Retour</button>
            <button class="btn-primary" onclick="showStep(5)">âœ… Je suis bien placÃ©</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 5 : Pelotes -->
    <div id="step5" class="step">
      <div class="card glass-effect">
        <h2>ğŸ§¶ La Toile d'AraignÃ©e</h2>
        <div class="info-box" style="background: rgba(255,255,255,0.1); border-left: 4px solid #F59E0B;">
          <h3>ğŸ•¸ï¸ Consigne :</h3>
          <p>Avec l'aide de vos voisins, tentez de dessiner votre parcours le plus fidÃ¨lement possible.</p>
          <p>En route pour une belle toile d'araignÃ©e !</p>
          <hr style="border:0; border-top:1px solid rgba(255,255,255,0.2); margin:10px 0;">
          <ul style="margin-left:20px;"><li>ğŸŸ¡ Voiture</li><li>ğŸ”µ VÃ©lo/Marche</li><li>ğŸŒ¸ TC</li></ul>
        </div>
        
        <div class="stats-grid"><div class="stat-card"><div class="stat-number" id="totalParticipants">0</div>Joueurs</div><div class="stat-card"><div class="stat-number" id="avgDistance">0</div>Km Moy.</div></div>
        
        <div class="navigation-buttons">
            <button class="btn-outline" onclick="showStep(4)">Retour</button>
            <button class="btn-primary" onclick="showStep('stepCoConstruction')">Phase Discussion â¡ï¸</button>
        </div>
      </div>
    </div>

    <!-- NOUVELLE Ã‰TAPE : CO-CONSTRUCTION -->
    <div id="stepCoConstruction" class="step">
        <div class="card glass-effect">
            <h2>ğŸ’¡ Co-Construction</h2>
            <p class="subtitle">Discutez avec vos voisins pour identifier les solutions.</p>

            <h3 style="text-align:center; margin-bottom:15px;">Quelle est votre rÃ©alitÃ© ?</h3>
            <div class="coach-selector">
                <button class="btn-outline coach-btn" onclick="showMobilityAdvice('close')">ğŸ™ï¸ Proche (< 10km)</button>
                <button class="btn-outline coach-btn" onclick="showMobilityAdvice('far')">ğŸ›£ï¸ Ã‰loignÃ© (> 10km)</button>
            </div>

            <!-- Contenu Dynamique -->
            <div id="mobilityAdviceContent" style="display:none; margin-top:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:10px;">
                <h3 id="adviceTitle" style="color:var(--primary);"></h3>
                <div id="adviceText" style="font-size:0.9em; line-height:1.4;"></div>
                
                <div style="margin-top:15px; padding:10px; background:rgba(0,0,0,0.2); border-radius:8px;">
                    <strong>ğŸ¤” Questions pour le groupe :</strong>
                    <ul id="adviceQuestions" style="margin-left:20px; margin-top:5px; font-style:italic;"></ul>
                </div>
            </div>

            <!-- Note Groupe -->
            <h3 style="margin-top:25px;">ğŸ“ IdÃ©e clÃ© du groupe</h3>
            <textarea id="groupNote" rows="3" placeholder="Une solution, une idÃ©e, ou une remarque issue de votre discussion..." style="width:100%; padding:10px; border-radius:10px; background:rgba(0,0,0,0.3); color:white; border:1px solid rgba(255,255,255,0.2); font-family:inherit;"></textarea>

            <div class="navigation-buttons" style="margin-top:20px;">
                <button class="btn-outline" onclick="showStep(5)">Retour</button>
                <button class="btn-primary" onclick="showStep(6)">Mes Propositions â¡ï¸</button>
            </div>
        </div>
    </div>

    <!-- Ã‰tape 6 : Propositions -->
    <div id="step6" class="step">
      <div class="card glass-effect">
        <h2>ğŸ“ Mes Choix</h2>
        <h3>Alternatives</h3><div id="alternativesList"></div>
        <h3 style="margin-top:15px;">Contraintes</h3><div id="constraintsList"></div>
        <h3 style="margin-top:15px;">Leviers</h3><div id="leversList"></div>
        <h3 style="margin-top:15px;">Engagement</h3>
        <div class="range-container"><input type="range" id="commitmentRange" value="80" oninput="updateCommitmentValue()"><div class="range-value"><span id="commitmentValue">80</span>%</div></div>
        
        <div class="navigation-buttons">
            <button class="btn-outline" onclick="showStep('stepCoConstruction')">â¬…ï¸ Retour Discussion</button>
            <button class="btn-primary" onclick="showCompanyScan()">GÃ©nÃ©rer Rapport â¡ï¸</button>
        </div>
      </div>
    </div>

    <!-- Scan Entreprise -->
    <div id="companyScanPage" class="step">
      <div class="card glass-effect">
        <h2>ğŸ¢ Final</h2>
        <p>Scannez le QR Entreprise.</p>
        <div class="camera-container" id="companyCameraView" style="display:none;"><video id="companyVideo" autoplay playsinline muted></video></div>
        <button class="btn-primary" onclick="startScanLoop('company')">Scanner QR</button>
        <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(6)">â¬…ï¸ Modifier mes choix</button></div>
      </div>
    </div>

    <!-- Rapport -->
    <div id="reportPage" class="step">
      <div class="card glass-effect">
        <h2>ğŸ‰ Bilan</h2>
        <div class="co2-savings"><p>Gain potentiel</p><div class="co2-number" id="co2Savings">0</div>kg CO2/an</div>
        <button class="btn-primary" onclick="generatePDF()">ğŸ“„ Page Imprimable</button>
        <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(6)">â¬…ï¸ Modifier mes choix</button></div>
      </div>
    </div>

    <!-- Admin -->
    <div id="adminPage" class="step">
      <div class="card glass-effect">
        <h2>ğŸ” Admin</h2>
        <div id="adminLogin"><input type="password" id="adminPassword" placeholder="Mot de passe" /><button class="btn-primary" onclick="adminLogin()">OK</button></div>
        <div id="adminPanel" style="display:none;">
            <h3>QR Entreprise</h3>
            <input id="companyAddressInput" placeholder="Adresse" /><button class="btn-primary" onclick="generateCompanyQR()">GÃ©nÃ©rer</button>
            <div id="companyQRSection" style="display:none; background:white; padding:10px; border-radius:10px; margin-top:10px;">
                <div id="companyQrcode"></div>
            </div>
            <h3 style="margin-top:20px;">DonnÃ©es</h3>
            <button class="btn-primary" onclick="exportExcel()">ğŸ“¥ Exporter Excel</button>
            
            <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(1)">Retour</button></div>
        </div>
      </div>
    </div>

    <!-- Invitation DISTINCTE -->
    <div id="invitePage" class="step">
        <div class="card glass-effect invite-card">
            <h2 style="color:#F59E0B;">ğŸ“¨ INVITATION</h2>
            <p style="text-align:center; font-size:0.9em;">Ce code permet Ã  un collÃ¨gue de rejoindre le jeu.</p>
            <p style="text-align:center; font-weight:bold; color:#ef4444;">NE PAS SCANNER POUR JOUER</p>
            <div id="inviteTimer"></div>
            <div class="qr-wrapper qr-invite-wrapper"><div id="inviteQrcode"></div></div>
            <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(1)">Retour</button></div>
        </div>
    </div>

    <!-- Modale Multimodal -->
    <div id="multimodalModal" class="modal">
      <div class="modal-content glass-effect" style="background:#1e293b;">
        <h2>ğŸ”„ Modes Multiples</h2>
        <label>Choix du mode secondaire :</label>
        <select id="transportMode2" style="margin-top:10px;">
            <option value="">-- Choisir --</option>
            <option value="car-thermal">ğŸš— Voiture thermique</option>
            <option value="car-electric">âš¡ Voiture Ã©lec</option>
            <option value="carpool">ğŸš™ Covoiturage</option>
            <option value="train">ğŸš† Train/RER</option>
            <option value="bus">ğŸšŒ Bus/Tram</option>
            <option value="bike">ğŸš² VÃ©lo</option>
            <option value="ebike">ğŸš´ VÃ©lo Ã©lec</option>
            <option value="walk">ğŸš¶ Marche</option>
            <option value="remote">ğŸ’» TÃ©lÃ©travail</option>
        </select>
        
        <p style="margin: 15px 0; font-weight:bold; opacity:0.8;">RÃ©partition (jours par semaine) :</p>
        <div style="display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:20px;">
            <div style="text-align:center;">
                <input type="number" id="mode1Days" value="3" min="0" max="5" style="width:60px; text-align:center;">
                <div style="font-size:0.8em; margin-top:5px;">Jours Mode 1</div>
            </div>
            <div style="font-size:1.5em; opacity:0.5;">/</div>
            <div style="text-align:center;">
                <input type="number" id="mode2Days" value="2" min="0" max="5" style="width:60px; text-align:center;">
                <div style="font-size:0.8em; margin-top:5px;">Jours Mode 2</div>
            </div>
        </div>
        
        <div class="navigation-buttons">
            <button class="btn-outline" onclick="closeMultimodal()">Annuler</button>
            <button class="btn-primary" onclick="saveMultimodal()">Valider</button>
        </div>
      </div>
    </div>

    <!-- Boutons flottants -->
    <button class="reset-floating-btn" onclick="resetGameSequence()">ğŸ”„</button>
    <button class="admin-floating-btn" onclick="showAdminPage()">ğŸ”</button>
    
    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  <script src="config.js"></script>
  <script src="script.js"></script>
</body>
</html>
