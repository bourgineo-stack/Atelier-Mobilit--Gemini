<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Atelier MobilitÃ© - Next Gen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <!-- Police moderne Outfit -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  
  <!-- CSS -->
  <link rel="stylesheet" href="style.css">
  
  <!-- BibliothÃ¨ques -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

  <!-- Fond animÃ© -->
  <div class="background-animation"></div>

  <div class="container">
    
    <!-- Header -->
    <header>
        <div class="brand">ğŸŒ± GoDifferent</div>
        <div class="step-indicator">
            <div class="step-dot active" id="step1Dot">1</div>
            <div class="step-dot" id="step2Dot">2</div>
            <div class="step-dot" id="step3Dot">3</div>
            <div class="step-dot" id="step4Dot">4</div>
            <div class="step-dot" id="step5Dot">5</div>
            <div class="step-dot" id="step6Dot">6</div>
        </div>
    </header>

    <!-- Notice RGPD -->
    <div id="rgpdNotice" class="card glass-effect" style="border-left: 4px solid #10b981;">
      <p style="font-size: 0.9em; margin-bottom: 15px; opacity: 0.9;">
        â„¹ï¸ Vos donnÃ©es sont stockÃ©es temporairement (7 jours max).
      </p>
      <button class="btn-primary" onclick="acceptRGPD()">âœ… J'accepte et je continue</button>
    </div>

    <!-- Ã‰tape 1 : Configuration -->
    <div id="step1" class="step active">
      <div class="card glass-effect">
        <h1>ğŸš€ Bienvenue !</h1>
        
        <div id="loginSection">
            <p class="subtitle">Entrez le code de l'atelier pour commencer.</p>
            <input type="text" id="accessCodeInput" placeholder="Code d'accÃ¨s" />
            <button class="btn-primary" onclick="checkAccessCode()">Valider</button>
            <div id="accessError" class="error-msg"></div>
        </div>
        
        <div id="locationSection" style="display: none;">
          <h3>ğŸ“ Votre profil</h3>
          
          <div class="input-group">
            <label>Adresse complÃ¨te</label>
            <input id="userAddress" placeholder="Ex: 10 rue de la LibertÃ©, Dijon" />
          </div>
          
          <div class="input-group">
            <label>Mode principal</label>
            <select id="transportMode">
                <option value="">-- Choisir --</option>
                <option value="car-thermal">ğŸš— Voiture thermique</option>
                <option value="car-electric">âš¡ Voiture Ã©lectrique</option>
                <option value="carpool">ğŸš™ Covoiturage</option>
                <option value="train">ğŸš† Train/RER</option>
                <option value="bus">ğŸšŒ Bus/Tram</option>
                <option value="bike">ğŸš² VÃ©lo</option>
                <option value="ebike">ğŸš´ VÃ©lo Ã©lectrique</option>
                <option value="walk">ğŸš¶ Marche</option>
                <option value="remote">ğŸ’» TÃ©lÃ©travail</option>
            </select>
          </div>
          
          <div class="input-group">
            <label>Heure de dÃ©part</label>
            <input type="time" id="departureTime" value="07:30" />
          </div>
          
          <div style="text-align: center; margin: 15px 0;">
            <label class="checkbox-item" style="background:transparent;">
              <input type="checkbox" id="multimodalCheck" onchange="toggleMultimodal()">
              <span>J'alterne entre plusieurs modes</span>
            </label>
          </div>
          
          <button class="btn-primary" id="saveLocation">Valider ma localisation</button>
        </div>

        <div id="afterLocationSection" style="display: none;">
          <div class="success-msg">âœ… Profil enregistrÃ© !</div>
          
          <div class="emoji-display">
            <p>Votre pseudo :</p>
            <div id="myEmojiDisplay" style="font-size: 4rem; animation: bounce 2s infinite;"></div>
          </div>
          
          <div class="info-box">
            <strong>ğŸ“ Adresse :</strong> <span id="detectedAddress"></span>
          </div>

          <button class="btn-secondary" onclick="showInvitePage()">ğŸ“¨ Inviter</button>
          <button class="btn-primary" onclick="showStep(2)">Commencer ğŸ®</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 2 : Rencontres -->
    <div id="step2" class="step">
      <div class="card glass-effect">
        <h2>ğŸ¤ Rencontres</h2>
        <p class="subtitle">Scannez les autres participants.</p>
        
        <div class="qr-wrapper">
            <div id="qrcode"></div>
        </div>

        <div class="camera-container" id="cameraView">
            <video id="video" autoplay playsinline muted></video>
            <div class="scan-overlay"></div>
        </div>
        <button class="btn-outline" id="stopCamBtn" style="display:none;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter camÃ©ra</button>

        <button class="btn-primary" id="scanBtn" onclick="startScanLoop('normal')">ğŸ“± Scanner</button>
        
        <div id="scanResult"></div>
        
        <!-- Challenge dynamique -->
        <div id="challengeSection" style="display: none;">
          <div class="feedback-card">
            <div style="font-size: 1.5rem;" id="challengeTitle"></div>
            <p id="challengeTask" style="margin: 10px 0;"></p>
            <button class="btn-secondary" id="continueChallengeBtn">âœ… C'est fait !</button>
          </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar"><div class="progress-fill" id="step2Progress" style="width: 0%"></div></div>
            <p style="text-align: center; font-size: 0.8rem;">Scans : <span id="scanCount">0</span></p>
        </div>

        <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(1)">â¬…ï¸ Retour</button>
          <button class="btn-primary" onclick="showStep(3)" id="goToStep3" disabled>â¡ï¸ Suivant</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 3 : DÃ©fi voisins -->
    <div id="step3" class="step">
      <div class="card glass-effect">
        <h2>ğŸ¯ Vos Voisins</h2>
        
        <div class="info-box">
          <p><strong>Mission :</strong> Scannez 3 de vos 5 voisins les plus proches.</p>
        </div>
        
        <div class="qr-wrapper-small">
            <div id="qrcodeStep3"></div>
        </div>

        <div class="game-header">
          <div class="score-box">
              <span class="score-label">TrouvÃ©s</span>
              <span class="score-val" id="scoreBadge">0/3</span>
          </div>
          <div class="score-box">
              <span class="score-label">Essais</span>
              <span class="score-val" id="attemptsLeft">5</span>
          </div>
        </div>

        <h3>Cibles potentielles :</h3>
        <div id="targetList"></div>

        <div class="camera-container" id="gameCameraView" style="display:none;">
            <video id="gameVideo" autoplay playsinline muted></video>
            <div class="scan-overlay"></div>
        </div>
        <button class="btn-outline" id="stopGameCamBtn" style="display:none;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>

        <button class="btn-primary" id="gameScanBtn" onclick="startScanLoop('game')">ğŸ“± Scanner un voisin</button>
        <div id="gameResult"></div>

        <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(2)">â¬…ï¸ Retour</button>
          <button class="btn-secondary" onclick="resetGame()">ğŸ”„ Retry</button>
          <button class="btn-primary" onclick="showStep(4)">â¡ï¸ Suite</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 4 : Positionnement -->
    <div id="step4" class="step">
      <div class="card glass-effect">
        <h2>ğŸ—ºï¸ Positionnement</h2>
        <div class="info-box">
            <p>Scannez les autres pour trianguler votre position dans la salle.</p>
        </div>
        
        <div class="qr-wrapper-small"><div id="qrcodeStep4"></div></div>
        
        <div class="camera-container" id="positioningCameraView" style="display:none;">
            <video id="positioningVideo" autoplay playsinline muted></video>
            <div class="scan-overlay"></div>
        </div>
        <button class="btn-outline" id="stopPosCamBtn" style="display:none;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>
        
        <button class="btn-primary" id="positioningScanBtn" onclick="startScanLoop('positioning')">ğŸ“± Scanner un participant</button>
        <div id="positioningScanResult"></div>
        
        <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(3)">â¬…ï¸ Retour</button>
          <button class="btn-primary" onclick="showStep(5)">âœ… Je suis placÃ©</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 5 : Pelotes -->
    <div id="step5" class="step">
      <div class="card glass-effect">
        <h2>ğŸ§¶ Les Pelotes</h2>
        <div class="info-box" style="text-align:left;">
          <h3>Instructions :</h3>
          <ul style="margin-left:20px;">
            <li>ğŸŸ¡ Voiture | ğŸ”µ VÃ©lo/Marche | ğŸŒ¸ TC</li>
            <li>DÃ©roulez votre pelote jusqu'au centre !</li>
          </ul>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalParticipants">0</div>
            <div class="stat-label">Participants</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avgDistance">0</div>
            <div class="stat-label">Km Moy.</div>
          </div>
        </div>
        
        <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(4)">â¬…ï¸ Retour</button>
          <button class="btn-primary" onclick="showStep(6)">â¡ï¸ Propositions</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 6 : Propositions -->
    <div id="step6" class="step">
      <div class="card glass-effect">
        <h2>ğŸ’¡ Propositions</h2>
        <p class="subtitle">Quelles alternatives testeriez-vous ?</p>
        
        <h3>ğŸš€ Alternatives</h3>
        <div id="alternativesList"></div>
        
        <h3 style="margin-top:20px;">âš ï¸ Contraintes</h3>
        <div id="constraintsList"></div>
        
        <h3 style="margin-top:20px;">ğŸ”“ Leviers</h3>
        <div id="leversList"></div>
        
        <h3 style="margin-top:20px;">ğŸ“Š Engagement</h3>
        <div class="range-container">
          <input type="range" id="commitmentRange" min="0" max="100" value="80" oninput="updateCommitmentValue()">
          <div class="range-value"><span id="commitmentValue">80</span>%</div>
        </div>
        
        <button class="btn-primary" onclick="showCompanyScan()">â¡ï¸ GÃ©nÃ©rer mon rapport</button>
        <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(5)">â¬…ï¸ Retour</button></div>
      </div>
    </div>

    <!-- Scan Entreprise -->
    <div id="companyScanPage" class="step">
      <div class="card glass-effect">
        <h2>ğŸ¢ DerniÃ¨re Ã©tape</h2>
        <p>Scannez le QR code "Entreprise" affichÃ© par l'animateur.</p>
        
        <div class="camera-container" id="companyCameraView" style="display:none;">
            <video id="companyVideo" autoplay playsinline muted></video>
            <div class="scan-overlay"></div>
        </div>
        <button class="btn-outline" id="stopCompCamBtn" style="display:none;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>

        <button class="btn-primary" onclick="startScanLoop('company')">ğŸ“± Scanner le QR</button>
        <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(6)">â¬…ï¸ Retour</button></div>
      </div>
    </div>

    <!-- Rapport -->
    <div id="reportPage" class="step">
      <div class="card glass-effect">
        <h2>ğŸ‰ RÃ©sultat</h2>
        
        <div class="co2-savings">
          <p style="opacity:0.8;">Gain potentiel</p>
          <div class="co2-number" id="co2Savings">0</div>
          <p>kg CO2 / an</p>
        </div>
        
        <div class="info-box">
          <button class="btn-primary" onclick="generatePDF()">ğŸ“¥ TÃ©lÃ©charger mon PDF</button>
        </div>
        <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(6)">â¬…ï¸ Retour</button></div>
      </div>
    </div>

    <!-- Admin & Autres -->
    <div id="invitePage" class="step">
        <div class="card glass-effect">
            <h2>ğŸ“¨ Inviter</h2>
            <div id="inviteTimer" class="invite-timer"></div>
            <div class="qr-wrapper"><div id="inviteQrcode"></div></div>
            <div class="navigation-buttons">
                <button class="btn-secondary" onclick="extendInviteTimer()">+30s</button>
                <button class="btn-outline" onclick="showStep(1)">Retour</button>
            </div>
        </div>
    </div>

    <div id="adminPage" class="step">
      <div class="card glass-effect">
        <h2>ğŸ” Admin</h2>
        <div id="adminLogin">
          <input type="password" id="adminPassword" placeholder="Mot de passe" />
          <button class="btn-primary" onclick="adminLogin()">Connexion</button>
          <div id="adminError" class="error-msg"></div>
        </div>
        
        <div id="adminPanel" style="display: none;">
          <h3>ğŸ¢ QR Entreprise</h3>
          <input id="companyAddressInput" placeholder="Adresse entreprise" />
          <button class="btn-primary" onclick="generateCompanyQR()">GÃ©nÃ©rer</button>
          <div id="companyQRSection" style="display:none; text-align:center; background:white; padding:10px; border-radius:10px; margin-top:10px;">
            <div id="companyQrcode"></div>
          </div>
          
          <h3 style="margin-top:20px;">ğŸ“Š Stats</h3>
          <div class="stats-grid">
            <div class="stat-card"><div class="stat-number" id="adminTotalUsers">0</div><div class="stat-label">Joueurs</div></div>
            <div class="stat-card"><div class="stat-number" id="adminAvgDistance">0</div><div class="stat-label">Km Moy.</div></div>
          </div>
          <div id="adminStats"></div>
          <div id="leaderboard" class="leaderboard"></div>
          
          <h3>âš™ï¸ Config</h3>
          <input id="googleScriptUrl" placeholder="URL Google Script" />
          <button class="btn-secondary" onclick="saveGoogleScriptUrl()">ğŸ’¾ Sauvegarder URL</button>
          <button class="btn-primary" onclick="exportExcel()" style="margin-top:10px;">ğŸ“Š Export Excel</button>
          <button class="btn-outline" style="border-color:#ef4444; color:#ef4444; margin-top:20px;" onclick="resetAllData()">ğŸ—‘ï¸ TOUT EFFACER</button>
          
          <div class="navigation-buttons"><button class="btn-outline" onclick="showStep(1)">â¬…ï¸ Retour</button></div>
        </div>
      </div>
    </div>

    <!-- Modale Multimodal -->
    <div id="multimodalModal" class="modal">
      <div class="modal-content glass-effect" style="background: rgba(15, 23, 42, 0.95);">
        <h2>ğŸ”„ Modes multiples</h2>
        <label>Mode secondaire</label>
        <select id="transportMode2">
          <option value="car-thermal">ğŸš— Voiture thermique</option>
          <option value="car-electric">âš¡ Voiture Ã©lectrique</option>
          <option value="carpool">ğŸš™ Covoiturage</option>
          <option value="train">ğŸš† Train/RER</option>
          <option value="bus">ğŸšŒ Bus/Tram</option>
          <option value="bike">ğŸš² VÃ©lo</option>
          <option value="walk">ğŸš¶ Marche</option>
          <option value="remote">ğŸ’» TÃ©lÃ©travail</option>
        </select>
        <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
          <input type="number" id="mode1Days" value="3" style="width:60px;"> j/princ
          <input type="number" id="mode2Days" value="2" style="width:60px;"> j/sec
        </div>
        <div class="navigation-buttons">
          <button class="btn-outline" onclick="closeMultimodal()">Annuler</button>
          <button class="btn-primary" onclick="saveMultimodal()">Valider</button>
        </div>
      </div>
    </div>

    <button class="admin-floating-btn" onclick="showAdminPage()">ğŸ”</button>
    
    <!-- Canvas cachÃ©s pour le traitement -->
    <canvas id="canvas"></canvas>
    <canvas id="gameCanvas"></canvas>
    <canvas id="companyCanvas"></canvas>
    <canvas id="positioningCanvas"></canvas>

  </div>

  <!-- SCRIPTS -->
  <script src="config.js"></script>
  <script src="script.js"></script>
</body>
</html>
